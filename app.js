class KisanVaaniApp {
    constructor() {
        this.recognition = null;
        this.synthesis = window.speechSynthesis;
        this.currentLang = 'hi-IN';
        this.isListening = false;

        // Multilingual translations
        this.translations = {
            'hi-IN': {
                'app.name': 'KisanVaani',
                'app.title': 'KisanVaani เคเคฟเคธเคพเคจ เคธเคนเคพเคฏเค',
                'greetings.welcome': 'เคจเคฎเคธเฅเคเคพเคฐ เคเคฟเคธเคพเคจ เคฎเคฟเคคเฅเคฐ!',
                'greetings.kochi': 'เคจเคฎเคธเฅเคเคพเคฐ เคเฅเคทเค เคฎเคฟเคคเฅเคฐ!',
                'greetings.wayanad': 'เคตเคพเคฏเคจเคพเคก เคเฅ เคเคฟเคธเคพเคจ, เคธเฅเคตเคพเคเคค!',
                'greetings.punjab': 'เคชเคเคเคพเคฌ เคเฅ เคเคฟเคธเคพเคจ เคญเคพเค, เคจเคฎเคธเฅเคเคพเคฐ!',
                'tip.title': '๐ก เคเค เคเฅ เคธเคฒเคพเคน',
                'tip.content': 'เคฌเคพเคฐเคฟเคถ เคเฅ เคฎเฅเคธเคฎ เคฎเฅเค เคงเคพเคจ เคเฅ เคธเคฟเคเคเคพเค 5-7 เคฆเคฟเคจ เคฎเฅเค เคเคฐเฅเคเฅค',
                'tip.coconut': 'เคจเคพเคฐเคฟเคฏเคฒ เคฎเฅเค เคฌเคก เคฐเฅเค เคเฅ เคเคพเคเค เคเคฐเฅเคเฅค',
                'tip.soil': 'เคฎเคฟเคเฅเคเฅ เคเคพ pH 6.5-7.5 เคฌเคจเคพเค เคฐเคเฅเคเฅค',
                'tip.organic': 'เคฎเคฟเคเฅเคเฅ เคเฅ เคธเฅเคนเคค เคเฅ เคฒเคฟเค เคเฅเคตเคฟเค เคเคพเคฆ เคเคพ เคเคชเคฏเฅเค เคเคฐเฅเคเฅค',
                'voice.title': '๐ค เคเคตเคพเคเคผ เคธเฅ เคชเฅเคเฅเค!',
                'voice.description': 'เคซเคธเคฒ, เคฎเฅเคธเคฎ, เคฆเคพเคฎ, เคฏเฅเคเคจเคพ - เคฌเฅเคฒเฅเค เคฏเคพ เคเคพเคเคช เคเคฐเฅเคเฅค',
                'mic.checking': 'เคฎเคพเคเคเฅเคฐเฅเคซเคผเฅเคจ เคเคพเคเค เคฐเคนเฅ เคนเฅเค...',
                'mic.ready': 'เคฎเคพเคเคเฅเคฐเฅเคซเคผเฅเคจ เคคเฅเคฏเคพเคฐ!',
                'mic.listening': 'เคธเฅเคจ เคฐเคนเฅ เคนเฅเค... เคฌเฅเคฒเคฟเค!',
                'mic.heard': 'เคธเฅเคจเคพ เคเคฏเคพ:',
                'mic.denied': 'เคฎเคพเคเคเฅเคฐเฅเคซเคผเฅเคจ เคเฅ เคเคจเฅเคฎเคคเคฟ เคจเคนเฅเค เคฎเคฟเคฒเฅเฅค เคเคจเฅเคฎเคคเคฟ เคฆเฅเค เคเคฐ เคซเคฟเคฐ เคเฅเคถเคฟเคถ เคเคฐเฅเคเฅค',
                'mic.nospeech': 'เคเคตเคพเคเคผ เคจเคนเฅเค เคธเฅเคจเฅเฅค เคซเคฟเคฐ เคเฅเคถเคฟเคถ เคเคฐเฅเคเฅค',
                'mic.error': 'เคเคตเคพเคเคผ เคฎเฅเค เคคเฅเคฐเฅเคเคฟ:',
                'input.placeholder': 'เคฏเคนเคพเค เคเคพเคเคช เคเคฐเฅเค...',
                'buttons.send': 'เคญเฅเคเฅเค',
                'photo.title': '๐ท เคซเคธเคฒ เคซเฅเคเฅ เคเคชเคฒเฅเคก',
                'photo.description': 'เคเคชเคจเฅ เคซเคธเคฒ เคเฅ เคซเฅเคเฅ เคเคชเคฒเฅเคก เคเคฐเฅเค เคเคฐ เคธเคฎเคธเฅเคฏเคพ เคชเคคเคพ เคเคฐเฅเค',
                'photo.submit': 'เคซเฅเคเฅ เคเคพ เคตเคฟเคถเฅเคฒเฅเคทเคฃ เคเคฐเฅเค',
                'photo.select': 'เคเฅเคชเคฏเคพ เคเค เคซเฅเคเฅ เคเฅเคจเฅเคเฅค',
                'photo.analyzing': 'เคซเฅเคเฅ เคเคพ เคตเคฟเคถเฅเคฒเฅเคทเคฃ เคนเฅ เคฐเคนเคพ เคนเฅ...',
                'photo.ready': 'เคซเฅเคเฅ เคคเฅเคฏเคพเคฐ!',
                'photo.complete': 'เคตเคฟเคถเฅเคฒเฅเคทเคฃ เคชเฅเคฐเคพ!',
                'weather.title': '๐ค๏ธ เคฎเฅเคธเคฎ',
                'weather.placeholder': 'เคถเคนเคฐ เคเคพ เคจเคพเคฎ',
                'weather.button': 'เคฎเฅเคธเคฎ เคฆเฅเคเฅเค',
                'mandi.title': '๐ฐ เคฌเคพเคเคพเคฐ เคญเคพเคต',
                'mandi.placeholder': 'เคซเคธเคฒ เคเคพ เคจเคพเคฎ',
                'mandi.button': 'เคฆเคพเคฎ เคเคพเคจเฅเค',
                'schemes.title': '๐๏ธ เคธเคฐเคเคพเคฐเฅ เคฏเฅเคเคจเคพเคเค',
                'response.title': '๐ เคเคตเคพเคฌ',
                'response.loading': 'โณ เคเคตเคพเคฌ เคคเฅเคฏเคพเคฐ เคนเฅ เคฐเคนเคพ เคนเฅ...',
                'nav.voice': '๐ค เคเคตเคพเคเคผ',
                'nav.photo': '๐ท เคซเฅเคเฅ',
                'nav.weather': '๐ค๏ธ เคฎเฅเคธเคฎ',
                'nav.mandi': '๐ฐ เคฆเคพเคฎ',
                'nav.schemes': '๐๏ธ เคฏเฅเคเคจเคพ',
                'diagnosis': '๐ เคฐเฅเค เคจเคฟเคฆเคพเคจ:',
                'solution': '๐ก เคธเคฎเคพเคงเคพเคจ:',
                'fertilizers': '๐งช เคธเฅเคเคพเค เคเค เคเคพเคฆ:',
                'weather.info': 'เคฎเฅเคธเคฎ: 28ยฐC, เคฌเคพเคฐเคฟเคถ เคเฅ เคธเคเคญเคพเคตเคจเคพ 70%เฅค เคเฅเคคเฅ เคเฅ เคเคพเคฎ เคเฅ เคฒเคฟเค เคเคจเฅเคเฅเคฒเฅค',
                'price.info': 'เคญเคพเคต: โน30/เคเคฟเคฒเฅ (เคฆเคฟเคฒเฅเคฒเฅ เคฎเคเคกเฅ)เฅค เคฌเคฟเคเฅเคฐเฅ เคเฅ เคฒเคฟเค เคเคเฅเคเคพ เคธเคฎเคฏเฅค',
                'general.advice': 'เคฎเคฟเคเฅเคเฅ เคเฅ เคเคพเคเค เคเคฐเคพเคเคเฅค pH 6.5-7.5 เคฐเคเฅเคเฅค เคเฅเคตเคฟเค เคเคพเคฆ เคเคพ เคเคธเฅเคคเฅเคฎเคพเคฒ เคเคฐเฅเคเฅค'
            },
            'ml-IN': {
                'app.name': 'KisanVaani',
                'app.title': 'KisanVaani เดเตผเดทเด เดธเดนเดพเดฏเดฟ',
                'greetings.welcome': 'เดจเดฎเดธเตเดเดพเดฐเด เดเตผเดทเด เดธเตเดนเตเดคเตเดคเต!',
                'greetings.kochi': 'เดจเดฎเดธเตเดเดพเดฐเด, เดเตเดเตเดเดฟ เดเตผเดทเดเต!',
                'greetings.wayanad': 'เดตเดฏเดจเดพเดเต เดเตผเดทเดเดพ, เดธเตเดตเดพเดเดคเด!',
                'greetings.punjab': 'เดชเดเตเดเดพเดฌเต เดเตผเดทเดเดพ, เดจเดฎเดธเตเดเดพเดฐเด!',
                'tip.title': '๐ก เดเดจเตเดจเดคเตเดคเต เดเดฟเดชเตเดชเต',
                'tip.content': 'เดฎเดดเดเตเดเดพเดฒเดคเตเดคเต เดจเตเดฒเตเดฒเต เดเดฒเดธเตเดเดจเด 5-7 เดฆเดฟเดตเดธเดคเตเดคเดฟเดฒเตเดฐเดฟเดเตเดเตฝ.',
                'tip.coconut': 'เดจเดพเดณเดฟเดเตเดฐเด เดฌเดกเต เดฑเตเดเตเดเต เดชเดฐเดฟเดถเตเดงเดฟเดเตเดเตเด.',
                'tip.soil': 'เดฎเดฃเตเดฃเดฟเดจเตเดฑเต pH 6.5-7.5 เดตเดฐเต เดจเดฟเดฒเดจเดฟเตผเดคเตเดคเตเด.',
                'tip.organic': 'เดฎเดฃเตเดฃเดฟเดจเตเดฑเต เดเดฐเตเดเตเดฏเดคเตเดคเดฟเดจเดพเดฏเดฟ เดเตเดต เดตเดณเด เดเดชเดฏเตเดเดฟเดเตเดเตเด.',
                'voice.title': '๐ค เดถเดฌเตเดฆเดคเตเดคเดฟเดฒเตเดเต เดเตเดฆเดฟเดเตเดเต!',
                'voice.description': 'เดซเดธเตฝ, เดเดพเดฒเดพเดตเดธเตเดฅ, เดตเดฟเดฒ, เดชเดฆเตเดงเดคเดฟ โ เดชเดฑเดฏเต เดเดฒเตเดฒเตเดเตเดเดฟเตฝ เดเตเดชเตเดชเต เดเตเดฏเตเดฏเต.',
                'mic.checking': 'เดฎเตเดเตเดฐเตเดซเตเตบ เดชเดฐเดฟเดถเตเดงเดฟเดเตเดเตเดจเตเดจเต...',
                'mic.ready': 'เดฎเตเดเตเดฐเตเดซเตเตบ เดคเดฏเตเดฏเดพเตผ!',
                'mic.listening': 'เดเตเตพเดเตเดเตเดจเตเดจเต... เดธเดเดธเดพเดฐเดฟเดเตเดเตเด!',
                'mic.heard': 'เดเตเดเตเดเต:',
                'mic.denied': 'เดฎเตเดเตเดฐเตเดซเตเตบ เดเดจเตเดฎเดคเดฟ เดจเดฟเดทเตเดงเดฟเดเตเดเต. เดเดจเตเดฎเดคเดฟ เดจเตฝเดเดฟ เดตเตเดฃเตเดเตเด เดถเตเดฐเดฎเดฟเดเตเดเตเด.',
                'mic.nospeech': 'เดถเดฌเตเดฆเด เดเตเดเตเดเดฟเดฒเตเดฒ. เดตเตเดฃเตเดเตเด เดถเตเดฐเดฎเดฟเดเตเดเตเด.',
                'mic.error': 'เดถเดฌเตเดฆ เดชเดฟเดถเดเต:',
                'input.placeholder': 'เดเดตเดฟเดเต เดเตเดชเตเดชเต เดเตเดฏเตเดฏเต...',
                'buttons.send': 'เดเดฏเดฏเตเดเตเดเตเด',
                'photo.title': '๐ท เดซเดธเตฝ เดซเตเดเตเดเต เดเดชเตโเดฒเตเดกเต',
                'photo.description': 'เดจเดฟเดเตเดเดณเตเดเต เดซเดธเดฒเดฟเดจเตเดฑเต เดซเตเดเตเดเต เดเดชเตโเดฒเตเดกเต เดเตเดฏเตเดคเต เดชเตเดฐเดถเตเดจเด เดเดฃเตเดเตเดคเตเดคเตเด',
                'photo.submit': 'เดซเตเดเตเดเต เดตเดฟเดถเดเดฒเดจเด เดเตเดฏเตเดฏเตเด',
                'photo.select': 'เดฆเดฏเดตเดพเดฏเดฟ เดเดฐเต เดซเตเดเตเดเต เดคเดฟเดฐเดเตเดเตเดเตเดเตเดเตเด.',
                'photo.analyzing': 'เดซเตเดเตเดเต เดตเดฟเดถเดเดฒเดจเด เดเตเดฏเตเดฏเตเดจเตเดจเต...',
                'photo.ready': 'เดซเตเดเตเดเต เดคเดฏเตเดฏเดพเดฑเดพเดฏเดฟ!',
                'photo.complete': 'เดตเดฟเดถเดเดฒเดจเด เดชเตเตผเดคเตเดคเตเดเดฐเดฟเดเตเดเต!',
                'weather.title': '๐ค๏ธ เดเดพเดฒเดพเดตเดธเตเดฅ',
                'weather.placeholder': 'เดจเดเดฐเด เดจเตฝเดเตเด',
                'weather.button': 'เดเดพเดฒเดพเดตเดธเตเดฅ เดเดพเดฃเตเด',
                'mandi.title': '๐ฐ เดฎเดพเตผเดเตเดเดฑเตเดฑเต เดตเดฟเดฒ',
                'mandi.placeholder': 'เดซเดธเตฝ เดชเตเดฐเต',
                'mandi.button': 'เดตเดฟเดฒ เดเดจเตเดตเตเดทเดฟเดเตเดเตเด',
                'schemes.title': '๐๏ธ เดธเตผเดเตเดเดพเตผ เดชเดฆเตเดงเดคเดฟเดเตพ',
                'response.title': '๐ เดเดคเตเดคเดฐเด',
                'response.loading': 'โณ เดเดคเตเดคเดฐเด เดคเดฏเตเดฏเดพเดฑเดพเดเตเดเตเดจเตเดจเต...',
                'nav.voice': '๐ค เดถเดฌเตเดฆเด',
                'nav.photo': '๐ท เดซเตเดเตเดเต',
                'nav.weather': '๐ค๏ธ เดเดพเดฒเดพเดตเดธเตเดฅ',
                'nav.mandi': '๐ฐ เดตเดฟเดฒ',
                'nav.schemes': '๐๏ธ เดชเดฆเตเดงเดคเดฟ',
                'diagnosis': '๐ เดฐเตเดเดจเดฟเตผเดฃเตเดฃเดฏเด:',
                'solution': '๐ก เดชเดฐเดฟเดนเดพเดฐเด:',
                'fertilizers': '๐งช เดถเตเดชเดพเตผเดถ เดเตเดฏเตเดฏเตเดจเตเดจ เดฐเดพเดธเดตเดณเดเตเดเตพ:',
                'weather.info': 'เดเดพเดฒเดพเดตเดธเตเดฅ: 28ยฐC, เดฎเดด เดธเดพเดงเตเดฏเดค 70%. เดเดพเตผเดทเดฟเด เดชเตเดฐเดตเตผเดคเตเดคเดจเดเตเดเตพเดเตเดเต เดเดจเตเดเตเดฒเด.',
                'price.info': 'เดตเดฟเดฒ: โน30/เดเดฟเดฒเต (เดเตเดเตเดเดฟ เดฎเดฃเตเดเดฟ). เดตเดฟเตฝเดชเตเดชเดจเดฏเตเดเตเดเต เดเดจเตเดเตเดฒ เดธเดฎเดฏเด.',
                'general.advice': 'เดฎเดฃเตเดฃเต เดชเดฐเดฟเดถเตเดงเดจ เดจเดเดคเตเดคเตเด. pH 6.5-7.5 เดจเดฟเดฒเดจเดฟเตผเดคเตเดคเตเด. เดเตเดต เดเดฎเตเดชเตเดธเตเดฑเตเดฑเต เดเดชเดฏเตเดเดฟเดเตเดเตเด.'
            },
            'en-IN': {
                'app.name': 'KisanVaani',
                'app.title': 'KisanVaani Farmer Assistant',
                'greetings.welcome': 'Welcome, dear farmer!',
                'greetings.kochi': 'Welcome, Kochi farmer!',
                'greetings.wayanad': 'Wayanad farmer, welcome!',
                'greetings.punjab': 'Punjab farmer brother, welcome!',
                'tip.title': '๐ก Today's Tip',
                'tip.content': 'During monsoon, irrigate paddy every 5-7 days.',
                'tip.coconut': 'Check coconut for bud rot during rainy season.',
                'tip.soil': 'Maintain soil pH between 6.5-7.5.',
                'tip.organic': 'Use organic fertilizers for better soil health.',
                'voice.title': '๐ค Ask by Voice!',
                'voice.description': 'Crop, weather, price, scheme - speak or type your query.',
                'mic.checking': 'Checking microphone...',
                'mic.ready': 'Microphone ready!',
                'mic.listening': 'Listening... speak now!',
                'mic.heard': 'Heard:',
                'mic.denied': 'Microphone access denied. Please allow microphone access and try again.',
                'mic.nospeech': 'No speech heard. Please try again.',
                'mic.error': 'Speech error:',
                'input.placeholder': 'Type here...',
                'buttons.send': 'Send',
                'photo.title': '๐ท Upload Crop Photo',
                'photo.description': 'Upload your crop photo to identify problems',
                'photo.submit': 'Analyze Photo',
                'photo.select': 'Please select a photo.',
                'photo.analyzing': 'Analyzing photo...',
                'photo.ready': 'Photo ready!',
                'photo.complete': 'Analysis complete!',
                'weather.title': '๐ค๏ธ Weather',
                'weather.placeholder': 'Enter city name',
                'weather.button': 'Get Weather',
                'mandi.title': '๐ฐ Market Price',
                'mandi.placeholder': 'Crop name',
                'mandi.button': 'Check Price',
                'schemes.title': '๐๏ธ Government Schemes',
                'response.title': '๐ Answer',
                'response.loading': 'โณ Preparing answer...',
                'nav.voice': '๐ค Voice',
                'nav.photo': '๐ท Photo',
                'nav.weather': '๐ค๏ธ Weather',
                'nav.mandi': '๐ฐ Price',
                'nav.schemes': '๐๏ธ Schemes',
                'diagnosis': '๐ Diagnosis:',
                'solution': '๐ก Solution:',
                'fertilizers': '๐งช Recommended Fertilizers:',
                'weather.info': 'Weather: 28ยฐC, 70% chance of rain. Suitable for farming activities.',
                'price.info': 'Price: โน30/kg (Delhi Mandi). Good time for selling.',
                'general.advice': 'Test your soil. Maintain pH 6.5-7.5. Use organic compost.'
            }
        };

        // Enhanced agricultural data with multilingual support
        this.agriculturalData = {
            'hi-IN': {
                cropProblems: {
                    'เคชเคคเฅเคคเฅ เคชเฅเคฒเฅ': { 
                        diagnosis: 'เคจเคพเคเคเฅเคฐเฅเคเคจ เคเฅ เคเคฎเฅ', 
                        solution: 'เคฏเฅเคฐเคฟเคฏเคพ 25 เคเคฟเคฒเฅ/เคเคเคกเคผ เคกเคพเคฒเฅเคเฅค เคฌเคพเคฐเคฟเคถ เคธเฅ เคชเคนเคฒเฅ เคฆเฅเคเฅค',
                        fertilizers: ['เคฏเฅเคฐเคฟเคฏเคพ', 'เคเคฎเฅเคจเคฟเคฏเคฎ เคธเคฒเฅเคซเฅเค', 'เคเฅเคตเคฟเค เคเคพเคฆ']
                    },
                    'yellow leaves': { 
                        diagnosis: 'เคจเคพเคเคเฅเคฐเฅเคเคจ เคเฅ เคเคฎเฅ', 
                        solution: 'เคฏเฅเคฐเคฟเคฏเคพ 25 เคเคฟเคฒเฅ/เคเคเคกเคผ เคกเคพเคฒเฅเคเฅค เคเฅเคตเคฟเค เคเคพเคฆ เคญเฅ เคฎเคฟเคฒเคพเคเคเฅค',
                        fertilizers: ['เคฏเฅเคฐเคฟเคฏเคพ', 'เคเคฎเฅเคจเคฟเคฏเคฎ เคธเคฒเฅเคซเฅเค', 'เคเฅเคตเคฟเค เคเคฎเฅเคชเฅเคธเฅเค']
                    },
                    'เคชเคคเฅเคคเฅ เคฎเฅเคฐเคเคพเค': {
                        diagnosis: 'เคชเคพเคจเฅ เคเฅ เคเคฎเฅ เคฏเคพ เคเคกเคผ เคธเคกเคผเคจ',
                        solution: 'เคธเคฟเคเคเคพเค เคฆเฅเคเฅเคเฅค เคเคพเคฐเฅเคฌเฅเคเคกเคพเคเคฟเคฎ เคเคฟเคกเคผเคเคพเคต เคเคฐเฅเคเฅค',
                        fertilizers: ['เคเคพเคฐเฅเคฌเฅเคเคกเคพเคเคฟเคฎ', 'NPK 19:19:19']
                    },
                    'brown spots': {
                        diagnosis: 'เคซเคเคเคฒ เคธเคเคเฅเคฐเคฎเคฃ',
                        solution: 'เคเคพเคฐเฅเคฌเฅเคเคกเคพเคเคฟเคฎ เคธเฅเคชเฅเคฐเฅ เคเคฐเฅเคเฅค เคนเคตเคพ เคเคพ เคธเคเคเคพเคฐ เคฌเคขเคผเคพเคเคเฅค',
                        fertilizers: ['เคเคพเคฐเฅเคฌเฅเคเคกเคพเคเคฟเคฎ', 'เคเฅเคชเคฐ เคธเคฒเฅเคซเฅเค', 'เคจเฅเคฎ เคคเฅเคฒ']
                    }
                }
            },
            'ml-IN': {
                cropProblems: {
                    'เดเดฒเดเตพ เดฎเดเตเด': { 
                        diagnosis: 'เดจเตเดเตเดฐเดเตป เดเตเดฑเดตเต', 
                        solution: 'เดฏเตเดฑเดฟเดฏ 25kg/เดเดเตเดเตผ เดคเดณเดฟเดเตเดเตเด. เดฎเดดเดฏเตเดเตเดเต เดฎเตเดฎเตเดชเต เดจเตฝเดเตเด.',
                        fertilizers: ['เดฏเตเดฑเดฟเดฏ', 'เดเดฎเตเดฃเดฟเดฏเด เดธเตพเดซเตเดฑเตเดฑเต', 'เดเตเดต เดเดฎเตเดชเตเดธเตเดฑเตเดฑเต']
                    },
                    'yellow leaves': { 
                        diagnosis: 'เดจเตเดเตเดฐเดเตป เดเตเดฑเดตเต', 
                        solution: 'เดฏเตเดฑเดฟเดฏ 25kg/เดเดเตเดเตผ เดชเตเดฐเดฏเตเดเดฟเดเตเดเตเด. เดเตเดต เดเดฎเตเดชเตเดธเตเดฑเตเดฑเต เดเตเตผเดเตเดเตเด.',
                        fertilizers: ['เดฏเตเดฑเดฟเดฏ', 'เดเดฎเตเดฃเดฟเดฏเด เดธเตพเดซเตเดฑเตเดฑเต', 'เดเตเดต เดเดฎเตเดชเตเดธเตเดฑเตเดฑเต']
                    },
                    'เดเดฒเดเตพ เดตเดพเดเดฟ': {
                        diagnosis: 'เดเดฒ เดเตเดฑเดตเต เดเดฒเตเดฒเตเดเตเดเดฟเตฝ เดตเตเดฐเตเดเตเดฏเตฝ',
                        solution: 'เดเดฒเดธเตเดเดจเด เดชเดฐเดฟเดถเตเดงเดฟเดเตเดเตเด. เดเดพเตผเดฌเตเตปเดกเดพเดธเดฟเด เดธเตเดชเตเดฐเต เดเตเดฏเตเดฏเตเด.',
                        fertilizers: ['เดเดพเตผเดฌเตเตปเดกเดพเดธเดฟเด', 'NPK 19:19:19']
                    },
                    'brown spots': {
                        diagnosis: 'เดซเดเดเตฝ เดเดฃเตเดฌเดพเดง',
                        solution: 'เดเดพเตผเดฌเตเตปเดกเดพเดธเดฟเด เดธเตเดชเตเดฐเต เดเตเดฏเตเดฏเตเด. เดตเดพเดฏเต เดธเดเตเดเดพเดฐเด เดฎเตเดเตเดเดชเตเดชเตเดเตเดคเตเดคเตเด.',
                        fertilizers: ['เดเดพเตผเดฌเตเตปเดกเดพเดธเดฟเด', 'เดเตเดชเตเดชเตผ เดธเตพเดซเตเดฑเตเดฑเต', 'เดตเตเดชเตเดชเตเดฃเตเดฃ']
                    }
                }
            },
            'en-IN': {
                cropProblems: {
                    'yellow leaves': { 
                        diagnosis: 'Nitrogen deficiency', 
                        solution: 'Apply Urea 25kg/acre before rain. Use organic compost too.',
                        fertilizers: ['Urea', 'Ammonium Sulfate', 'Organic Compost']
                    },
                    'wilted leaves': {
                        diagnosis: 'Water stress or root rot',
                        solution: 'Check irrigation. Apply Carbendazim spray.',
                        fertilizers: ['Carbendazim', 'NPK 19:19:19']
                    },
                    'brown spots': {
                        diagnosis: 'Fungal infection',
                        solution: 'Use Carbendazim spray. Improve air circulation.',
                        fertilizers: ['Carbendazim', 'Copper Sulfate', 'Neem Oil']
                    }
                }
            }
        };

        this.schemes = {
            'hi-IN': [
                { name: "PM-KISAN", desc: "โน6000/เคธเคพเคฒ", link: "https://pmkisan.gov.in/" },
                { name: "Pradhan Mantri Fasal Bima Yojana", desc: "เคซเคธเคฒ เคฌเฅเคฎเคพ เคฏเฅเคเคจเคพ", link: "#" },
                { name: "Kisan Credit Card", desc: "เคเคฟเคธเคพเคจ เคเฅเคฐเฅเคกเคฟเค เคเคพเคฐเฅเคก", link: "#" }
            ],
            'ml-IN': [
                { name: "PM-KISAN", desc: "โน6000/เดตเตผเดทเด", link: "https://pmkisan.gov.in/" },
                { name: "Kudumbashree", desc: "เดเตผเดทเด เดตเดพเดฏเตเดชเดเตพ", link: "https://www.kudumbashree.org/" },
                { name: "ATMA", desc: "เดเดพเตผเดทเดฟเด เดตเดฟเดชเตเดฒเตเดเดฐเดฃเด", link: "#" }
            ],
            'en-IN': [
                { name: "PM-KISAN", desc: "โน6000/year direct benefit", link: "https://pmkisan.gov.in/" },
                { name: "Crop Insurance Scheme", desc: "Pradhan Mantri Fasal Bima Yojana", link: "#" },
                { name: "Kisan Credit Card", desc: "Agricultural credit facility", link: "#" }
            ]
        };

        this.initApp();
    }

    initApp() {
        // Show splash screen for 3 seconds
        setTimeout(() => {
            document.getElementById('splash').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
        }, 3000);

        this.updateLanguage();
        this.checkSystemRequirements();
        this.setupEventListeners();
        this.populateSchemes();
    }

    updateLanguage() {
        // Update all text elements with data-i18n attributes
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            const translation = this.translations[this.currentLang][key];
            if (translation) {
                element.textContent = translation;
            }
        });

        // Update placeholders
        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            const translation = this.translations[this.currentLang][key];
            if (translation) {
                element.placeholder = translation;
            }
        });

        // Set random greeting
        const greetingKeys = ['greetings.welcome', 'greetings.kochi', 'greetings.wayanad', 'greetings.punjab'];
        const randomKey = greetingKeys[Math.floor(Math.random() * greetingKeys.length)];
        document.getElementById('greeting').textContent = this.translations[this.currentLang][randomKey];

        // Set random daily tip
        const tipKeys = ['tip.content', 'tip.coconut', 'tip.soil', 'tip.organic'];
        const randomTipKey = tipKeys[Math.floor(Math.random() * tipKeys.length)];
        document.getElementById('dailyTip').textContent = this.translations[this.currentLang][randomTipKey];

        // Update document language
        document.documentElement.lang = this.currentLang.split('-')[0];
    }

    checkSystemRequirements() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const micBtn = document.getElementById('micBtn');
        const status = document.getElementById('status');

        if (SpeechRecognition) {
            micBtn.disabled = false;
            status.textContent = this.translations[this.currentLang]['mic.ready'];
            status.style.color = 'green';
        } else {
            status.textContent = 'Speech recognition not supported';
            status.style.color = 'red';
        }

        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            status.textContent = 'HTTPS required for microphone access';
            status.style.color = 'orange';
        }
    }

    setupEventListeners() {
        const micBtn = document.getElementById('micBtn');
        const sendBtn = document.getElementById('sendBtn');
        const textInput = document.getElementById('textInput');
        const langSelect = document.getElementById('langSelect');
        const weatherBtn = document.getElementById('weatherBtn');
        const mandiBtn = document.getElementById('mandiBtn');
        const photoInput = document.getElementById('photoInput');
        const photoSubmitBtn = document.getElementById('photoSubmitBtn');

        // Language selection with dynamic update
        langSelect.addEventListener('change', (e) => {
            this.currentLang = e.target.value;
            this.updateLanguage();
            this.checkSystemRequirements();
            this.populateSchemes();
        });

        // Voice input
        micBtn.addEventListener('click', () => this.startVoiceInput());

        // Text input
        sendBtn.addEventListener('click', () => this.processTextInput());
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.processTextInput();
        });

        // Weather and Mandi
        weatherBtn.addEventListener('click', () => this.fetchWeather(document.getElementById('cityInput').value || 'Delhi'));
        mandiBtn.addEventListener('click', () => this.fetchMandiPrices(document.getElementById('mandiSearch').value || 'Tomato'));

        // Photo upload functionality
        photoInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                this.previewImage(e.target.files[0]);
            }
        });

        photoSubmitBtn.addEventListener('click', () => this.analyzePhoto());

        // Bottom navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelector('.nav-btn.active')?.classList.remove('active');
                e.target.classList.add('active');

                // Hide all sections
                document.querySelectorAll('.section-card, .voice-card').forEach(sec => sec.classList.add('hidden'));

                // Show selected section
                const section = e.target.dataset.section;
                if (section === 'voice') {
                    document.getElementById('voice-card').classList.remove('hidden');
                } else {
                    document.getElementById(section + 'Section').classList.remove('hidden');
                }
            });
        });
    }

    async startVoiceInput() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const micBtn = document.getElementById('micBtn');
        const status = document.getElementById('status');

        if (!SpeechRecognition) {
            this.showError('Speech recognition not supported in this browser.');
            return;
        }

        if (this.isListening) {
            this.stopListening();
            return;
        }

        try {
            this.recognition = new SpeechRecognition();
            this.recognition.lang = this.currentLang;
            this.recognition.continuous = false;
            this.recognition.interimResults = false;

            this.recognition.onstart = () => {
                this.isListening = true;
                micBtn.classList.add('listening');
                micBtn.textContent = '๐';
                status.textContent = this.translations[this.currentLang]['mic.listening'];
                status.style.color = 'blue';
            };

            this.recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('textInput').value = transcript;
                status.textContent = `${this.translations[this.currentLang]['mic.heard']} "${transcript}"`;
                this.processQuery(transcript);
                this.stopListening();
            };

            this.recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                let errorMessage = this.translations[this.currentLang]['mic.error'] + ' ';

                switch(event.error) {
                    case 'not-allowed':
                        errorMessage = this.translations[this.currentLang]['mic.denied'];
                        break;
                    case 'no-speech':
                        errorMessage = this.translations[this.currentLang]['mic.nospeech'];
                        break;
                    case 'network':
                        errorMessage += 'Network error';
                        break;
                    default:
                        errorMessage += event.error;
                }

                this.showError(errorMessage);
                this.stopListening();
            };

            this.recognition.onend = () => {
                this.stopListening();
            };

            this.recognition.start();

        } catch (error) {
            console.error('Error starting speech recognition:', error);
            this.showError('Cannot start microphone.');
        }
    }

    stopListening() {
        if (this.recognition) {
            this.recognition.stop();
        }

        const micBtn = document.getElementById('micBtn');
        const status = document.getElementById('status');

        this.isListening = false;
        micBtn.classList.remove('listening');
        micBtn.textContent = '๐ค';
        status.textContent = this.translations[this.currentLang]['mic.ready'];
        status.style.color = 'green';
    }

    processTextInput() {
        const textInput = document.getElementById('textInput');
        const query = textInput.value.trim();

        if (query) {
            this.processQuery(query);
            textInput.value = '';
        }
    }

    async processQuery(query) {
        const lowerQuery = query.toLowerCase();
        let response;

        // Show loading
        this.showLoading();

        if (lowerQuery.includes('เคฎเฅเคธเคฎ') || lowerQuery.includes('เดเดพเดฒเดพเดตเดธเตเดฅ') || lowerQuery.includes('weather')) {
            response = await this.fetchWeather('Delhi');
        } else if (lowerQuery.includes('เคฆเคพเคฎ') || lowerQuery.includes('เคตเคพเคฒ') || lowerQuery.includes('เดตเดฟเดฒ') || lowerQuery.includes('price') || lowerQuery.includes('เคฎเคพเคฐเฅเคเฅเค')) {
            response = await this.fetchMandiPrices('Tomato');
        } else {
            response = this.getAIResponse(lowerQuery);
        }

        this.showResponse(response);
        this.speakResponse(response);
    }

    previewImage(file) {
        const preview = document.getElementById('photoPreview');
        const reader = new FileReader();

        reader.onload = (e) => {
            preview.innerHTML = `<img src="${e.target.result}" alt="Crop preview" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;">`;
        };

        reader.readAsDataURL(file);
        document.getElementById('photoStatus').textContent = this.translations[this.currentLang]['photo.ready'];
    }

    async analyzePhoto() {
        const photoInput = document.getElementById('photoInput');
        const photoStatus = document.getElementById('photoStatus');

        if (!photoInput.files[0]) {
            photoStatus.textContent = this.translations[this.currentLang]['photo.select'];
            photoStatus.style.color = 'red';
            return;
        }

        photoStatus.textContent = this.translations[this.currentLang]['photo.analyzing'];
        photoStatus.style.color = 'blue';

        // Simulate AI analysis
        setTimeout(() => {
            const currentLangData = this.agriculturalData[this.currentLang];
            const problems = Object.values(currentLangData.cropProblems);
            const randomProblem = problems[Math.floor(Math.random() * problems.length)];

            const response = {
                diagnosis: randomProblem.diagnosis,
                solution: `${randomProblem.solution}\n\n${this.translations[this.currentLang]['fertilizers']} ${randomProblem.fertilizers.join(', ')}`,
                fertilizers: randomProblem.fertilizers
            };

            this.showResponse(response);
            this.speakResponse(response);

            photoStatus.textContent = this.translations[this.currentLang]['photo.complete'];
            photoStatus.style.color = 'green';
        }, 2000);
    }

    async fetchWeather(city) {
        return {
            solution: `${city} ${this.translations[this.currentLang]['weather.info']}`
        };
    }

    async fetchMandiPrices(commodity) {
        return {
            solution: `${commodity} ${this.translations[this.currentLang]['price.info']}`
        };
    }

    getAIResponse(query) {
        const lowerQuery = query.toLowerCase();
        const currentLangData = this.agriculturalData[this.currentLang];

        for (const [key, data] of Object.entries(currentLangData.cropProblems)) {
            if (lowerQuery.includes(key.toLowerCase()) || 
                lowerQuery.includes(data.diagnosis.toLowerCase())) {
                return {
                    diagnosis: data.diagnosis,
                    solution: `${data.solution}\n\n${this.translations[this.currentLang]['fertilizers']} ${data.fertilizers.join(', ')}`,
                    fertilizers: data.fertilizers
                };
            }
        }

        return { 
            diagnosis: this.translations[this.currentLang]['general.advice'].split('.')[0],
            solution: this.translations[this.currentLang]['general.advice'],
            fertilizers: ['NPK 19:19:19', 'เคเฅเคตเคฟเค เคเคฎเฅเคชเฅเคธเฅเค']
        };
    }

    speakResponse(response) {
        if (this.synthesis && response.solution) {
            this.synthesis.cancel();

            const text = response.solution.replace(/\n/g, ' ');
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = this.currentLang;
            utterance.rate = 0.8;
            utterance.volume = 1;

            this.synthesis.speak(utterance);
        }
    }

    showResponse(response) {
        const responseSection = document.getElementById('responseSection');
        const responseContent = document.getElementById('responseContent');

        let html = '';

        if (response.diagnosis) {
            html += `<div class="diagnosis"><strong>${this.translations[this.currentLang]['diagnosis']}</strong> ${response.diagnosis}</div>`;
        }

        if (response.solution) {
            html += `<div class="solution"><strong>${this.translations[this.currentLang]['solution']}</strong> ${response.solution.replace(/\n/g, '<br>')}</div>`;
        }

        if (response.fertilizers) {
            html += `<div class="fertilizers"><strong>${this.translations[this.currentLang]['fertilizers']}</strong><ul>`;
            response.fertilizers.forEach(fertilizer => {
                html += `<li>${fertilizer}</li>`;
            });
            html += `</ul></div>`;
        }

        responseContent.innerHTML = html;
        responseSection.classList.remove('hidden');

        responseSection.scrollIntoView({ behavior: 'smooth' });
    }

    showLoading() {
        const responseSection = document.getElementById('responseSection');
        const responseContent = document.getElementById('responseContent');

        responseContent.innerHTML = `<div class="loading">${this.translations[this.currentLang]['response.loading']}</div>`;
        responseSection.classList.remove('hidden');
    }

    showError(message) {
        const status = document.getElementById('status');
        status.textContent = message;
        status.style.color = 'red';

        setTimeout(() => {
            status.textContent = this.translations[this.currentLang]['mic.ready'];
            status.style.color = 'green';
        }, 5000);
    }

    populateSchemes() {
        const schemesList = document.getElementById('schemesList');
        schemesList.innerHTML = '';

        const currentSchemes = this.schemes[this.currentLang];
        currentSchemes.forEach(scheme => {
            const div = document.createElement('div');
            div.className = 'scheme-item';
            div.innerHTML = `
                <h4>${scheme.name}</h4>
                <p>${scheme.desc}</p>
                <a href="${scheme.link}" target="_blank">Know More</a>
            `;
            schemesList.appendChild(div);
        });
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new KisanVaaniApp();
});
